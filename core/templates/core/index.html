{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subject Manager - API Test Frontend</title>
    <link rel="stylesheet" href="{% static 'core/style.css' %}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Subject Manager</h1>
            <p class="subtitle">API Testing Frontend</p>
        </header>

        <!-- Create Subject Form -->
        <section class="card">
            <h2>Create New Subject</h2>
            <form id="createSubjectForm">
                <div class="form-group">
                    <label for="subjectName">Subject Name:</label>
                    <input type="text" id="subjectName" name="name" required placeholder="e.g., Mathematics">
                </div>
                <div class="form-group">
                    <label for="subjectDescription">Description:</label>
                    <textarea id="subjectDescription" name="description" rows="4" placeholder="Enter subject description..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Create Subject</button>
            </form>
            <div id="createMessage" class="message"></div>
        </section>

        <!-- Test API Connection -->
        <section class="card">
            <h2>Test API Connection</h2>
            <button onclick="testAPI()" class="btn btn-secondary">Test API</button>
            <div id="testMessage" class="message"></div>
        </section>

        <!-- View Specific Subject -->
        <section class="card">
            <h2>View Specific Subject</h2>
            <div class="form-group">
                <label for="subjectId">Subject ID:</label>
                <input type="number" id="subjectId" placeholder="Enter subject ID">
                <button onclick="getSubject()" class="btn btn-secondary">Get Subject</button>
            </div>
            <div id="subjectDetail" class="detail-box"></div>
        </section>

        <!-- List All Subjects -->
        <section class="card">
            <h2>All Subjects</h2>
            <button onclick="loadSubjects()" class="btn btn-secondary">Refresh List</button>
            <div id="subjectsList" class="subjects-container">
                <p class="info-text">Click "Refresh List" to load subjects</p>
            </div>
        </section>

        <hr class="section-divider">

        <!-- Study Sessions Section -->
        <header class="section-header">
            <h1>Study Sessions</h1>
        </header>

        <!-- Create Study Session Form -->
        <section class="card">
            <h2>Create New Study Session</h2>
            <form id="createStudySessionForm">
                <div class="form-group">
                    <label for="sessionSubject">Subject:</label>
                    <select id="sessionSubject" name="subject" required>
                        <option value="">Select a subject...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sessionDatetime">Date & Time:</label>
                    <input type="datetime-local" id="sessionDatetime" name="datetime" required>
                </div>
                <div class="form-group">
                    <label for="sessionDuration">Duration (minutes):</label>
                    <input type="number" id="sessionDuration" name="duration_minutes" required placeholder="e.g., 60" min="1">
                </div>
                <div class="form-group">
                    <label for="sessionNotes">Notes:</label>
                    <textarea id="sessionNotes" name="notes" rows="4" placeholder="Enter study session notes..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Create Study Session</button>
            </form>
            <div id="createSessionMessage" class="message"></div>
        </section>

        <!-- View Specific Study Session -->
        <section class="card">
            <h2>View Specific Study Session</h2>
            <div class="form-group">
                <label for="studySessionId">Study Session ID:</label>
                <input type="number" id="studySessionId" placeholder="Enter study session ID">
                <button onclick="getStudySession()" class="btn btn-secondary">Get Study Session</button>
            </div>
            <div id="studySessionDetail" class="detail-box"></div>
        </section>

        <!-- List All Study Sessions -->
        <section class="card">
            <h2>All Study Sessions</h2>
            <button onclick="loadStudySessions()" class="btn btn-secondary">Refresh List</button>
            <div id="studySessionsList" class="subjects-container">
                <p class="info-text">Click "Refresh List" to load study sessions</p>
            </div>
        </section>
    </div>

    <script>
        // Base API URL
        const API_BASE = '';

        // Load subjects on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadSubjects();
            loadStudySessions();
            loadSubjectsForDropdown();
        });

        // Create Subject Form Handler
        document.getElementById('createSubjectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('subjectName').value;
            const description = document.getElementById('subjectDescription').value;
            const messageDiv = document.getElementById('createMessage');

            try {
                const response = await fetch(`${API_BASE}/subject/0/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, description })
                });

                const data = await response.json();
                
                if (response.ok) {
                    messageDiv.className = 'message success';
                    messageDiv.textContent = data.message || 'Subject created successfully!';
                    document.getElementById('createSubjectForm').reset();
                    // Reload the subjects list
                    setTimeout(() => loadSubjects(), 500);
                } else {
                    messageDiv.className = 'message error';
                    messageDiv.textContent = data.error || 'Error creating subject';
                }
            } catch (error) {
                messageDiv.className = 'message error';
                messageDiv.textContent = 'Network error: ' + error.message;
            }
        });

        // Test API Connection
        async function testAPI() {
            const messageDiv = document.getElementById('testMessage');
            try {
                const response = await fetch(`${API_BASE}/test/`);
                const data = await response.json();
                messageDiv.className = 'message success';
                messageDiv.textContent = `‚úì ${data.message}`;
            } catch (error) {
                messageDiv.className = 'message error';
                messageDiv.textContent = 'API connection failed: ' + error.message;
            }
        }

        // Load All Subjects
        async function loadSubjects() {
            const container = document.getElementById('subjectsList');
            container.innerHTML = '<p class="info-text">Loading subjects...</p>';

            try {
                const response = await fetch(`${API_BASE}/subject-list/`);
                const subjects = await response.json();

                if (subjects.length === 0) {
                    container.innerHTML = '<p class="info-text">No subjects found. Create one using the form above!</p>';
                    return;
                }

                let html = '<div class="subject-grid">';
                subjects.forEach(subject => {
                    html += `
                        <div class="subject-item">
                            <h3>${subject.name}</h3>
                            <p class="subject-id">ID: ${subject.id}</p>
                            <p class="subject-description">${subject.description || 'No description'}</p>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<p class="error">Error loading subjects: ${error.message}</p>`;
            }
        }

        // Get Specific Subject
        async function getSubject() {
            const id = document.getElementById('subjectId').value;
            const detailDiv = document.getElementById('subjectDetail');

            if (!id) {
                detailDiv.innerHTML = '<p class="error">Please enter a subject ID</p>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/subject/${id}/`);
                
                if (!response.ok) {
                    throw new Error('Subject not found');
                }

                const subject = await response.json();
                detailDiv.innerHTML = `
                    <div class="detail-content">
                        <h3>${subject.name}</h3>
                        <p><strong>ID:</strong> ${subject.id}</p>
                        <p><strong>Description:</strong> ${subject.description || 'No description'}</p>
                    </div>
                `;
            } catch (error) {
                detailDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }

        // ===== STUDY SESSION FUNCTIONS =====

        // Load subjects into dropdown
        async function loadSubjectsForDropdown() {
            try {
                const response = await fetch(`${API_BASE}/subject-list/`);
                const subjects = await response.json();
                
                const select = document.getElementById('sessionSubject');
                select.innerHTML = '<option value="">Select a subject...</option>';
                
                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading subjects for dropdown:', error);
            }
        }

        // Create Study Session Form Handler
        document.getElementById('createStudySessionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const subject = document.getElementById('sessionSubject').value;
            const datetimeInput = document.getElementById('sessionDatetime').value;
            const duration_minutes = parseInt(document.getElementById('sessionDuration').value);
            const notes = document.getElementById('sessionNotes').value;
            const messageDiv = document.getElementById('createSessionMessage');

            // Validate inputs
            if (!subject) {
                messageDiv.className = 'message error';
                messageDiv.textContent = 'Please select a subject';
                return;
            }

            if (!datetimeInput) {
                messageDiv.className = 'message error';
                messageDiv.textContent = 'Please select a date and time';
                return;
            }

            // Convert datetime-local format to ISO format that Django expects
            const datetimeISO = new Date(datetimeInput).toISOString();

            try {
                const response = await fetch(`${API_BASE}/study-session/0/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        subject: parseInt(subject),
                        datetime: datetimeISO,
                        duration_minutes: duration_minutes,
                        notes: notes 
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    messageDiv.className = 'message success';
                    messageDiv.textContent = data.message || 'Study session created successfully!';
                    document.getElementById('createStudySessionForm').reset();
                    // Reload the study sessions list and dropdown
                    setTimeout(() => {
                        loadStudySessions();
                        loadSubjectsForDropdown();
                    }, 500);
                } else {
                    messageDiv.className = 'message error';
                    messageDiv.textContent = data.error || 'Error creating study session';
                }
            } catch (error) {
                messageDiv.className = 'message error';
                messageDiv.textContent = 'Network error: ' + error.message;
            }
        });

        // Load All Study Sessions
        async function loadStudySessions() {
            const container = document.getElementById('studySessionsList');
            container.innerHTML = '<p class="info-text">Loading study sessions...</p>';

            try {
                const response = await fetch(`${API_BASE}/study-session-list/`);
                const sessions = await response.json();

                if (sessions.length === 0) {
                    container.innerHTML = '<p class="info-text">No study sessions found. Create one using the form above!</p>';
                    return;
                }

                let html = '<div class="session-grid">';
                sessions.forEach(session => {
                    const date = new Date(session.datetime);
                    const formattedDate = date.toLocaleString();
                    
                    html += `
                        <div class="session-item">
                            <h3>${session.subject}</h3>
                            <p class="session-id">ID: ${session.id}</p>
                            <p class="session-datetime"><strong>üìÖ Date:</strong> ${formattedDate}</p>
                            <p class="session-duration"><strong>‚è±Ô∏è Duration:</strong> ${session.duration_minutes} minutes</p>
                            <p class="session-notes"><strong>üìù Notes:</strong> ${session.notes || 'No notes'}</p>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<p class="error">Error loading study sessions: ${error.message}</p>`;
            }
        }

        // Get Specific Study Session
        async function getStudySession() {
            const id = document.getElementById('studySessionId').value;
            const detailDiv = document.getElementById('studySessionDetail');

            if (!id) {
                detailDiv.innerHTML = '<p class="error">Please enter a study session ID</p>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/study-session/${id}/`);
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Study session not found');
                }

                const session = await response.json();
                const date = new Date(session.datetime);
                const formattedDate = date.toLocaleString();
                
                detailDiv.innerHTML = `
                    <div class="detail-content">
                        <h3>${session.subject_name}</h3>
                        <p><strong>ID:</strong> ${session.id}</p>
                        <p><strong>Subject ID:</strong> ${session.subject_id}</p>
                        <p><strong>Date & Time:</strong> ${formattedDate}</p>
                        <p><strong>Duration:</strong> ${session.duration_minutes} minutes</p>
                        <p><strong>Notes:</strong> ${session.notes || 'No notes'}</p>
                    </div>
                `;
            } catch (error) {
                detailDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>

